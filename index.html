<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSI Generator Service Planning Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-panel label {
            color: white;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .control-panel input[type="number"] {
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1em;
        }

        .metric-cards {
            /* Updated to fit 4 cards across */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .metric-card h3 {
            color: #764ba2;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .metric-card p.value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        /* The detail text is removed from HTML, but keeping this style for consistency */
        .metric-card p.detail {
            font-size: 0.9em;
            color: #555;
            min-height: 1.2em; /* Ensure cards don't jump when the detail text is empty */
        }
        
        .content-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .card.scenario-control {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .scenario-control h3 {
            color: white;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .scenario-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .scenario-btn {
            padding: 10px 15px;
            border: 2px solid white;
            border-radius: 8px;
            background: transparent;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .scenario-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .scenario-btn.active {
            background: white;
            color: #667eea;
            border-color: #667eea;
        }

        .service-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .service-card {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .service-card.disabled {
            opacity: 0.5;
            background: #f8f8f8;
        }

        .service-card h4 {
            font-size: 1em;
            margin-bottom: 10px;
            color: #333;
        }

        .service-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        /* New style for the specific catalyst control */
        .catalyst-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px 0;
            border-top: 1px solid #eee;
        }

        .service-card .stats {
            display: grid;
            /* Changed to 3 columns to include parts cost */
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .service-card .stat-item {
            font-size: 0.8em;
            text-align: center;
        }

        .service-card .stat-item strong {
            display: block;
            font-size: 1.1em;
            color: #667eea;
        }

        .service-card input[type="number"] {
            width: 70px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .service-card input[type="checkbox"] {
            transform: scale(1.2);
            accent-color: #667eea;
        }

        .chart-container {
            height: 300px;
            margin: 0 auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
            color: #333;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .total-row {
            background-color: #e6e6ff !important;
            font-weight: bold;
            color: #667eea;
            border-top: 2px solid #667eea;
        }

        .table-card tr.disabled {
            background-color: #eee !important;
            color: #999;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
            display: none;
        }

        .alert.savings {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert.savings.show {
            display: block;
        }
        
        .total-cost-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #e53935; /* Red color for cost */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PSI Generator Service Planning Dashboard ðŸ“Š</h1>

        <div class="card scenario-control">
            <h3>Load Preset Scenario</h3>
            <div class="scenario-buttons">
                <button class="scenario-btn active" id="preset-oem">OEM Intervals</button>
                <button class="scenario-btn" id="preset-optimized">Optimized</button>
            </div>
        </div>

        <div class="control-panel">
            <div class="control-group">
                <label for="totalUnits">Total Units in Fleet</label>
                <input type="number" id="totalUnits" value="750" min="1">
            </div>
            <div class="control-group">
                <label for="unitsPerMonth">Units Added/Month</label>
                <input type="number" id="unitsPerMonth" value="50" min="1">
            </div>
            <div class="control-group">
                <label for="annualRuntime">Annual Runtime (Hours/Unit)</label>
                <input type="number" id="annualRuntime" value="6500" min="100">
            </div>
            <div class="control-group">
                <label for="workingDays">Working Days/Year</label>
                <input type="number" id="workingDays" value="300" min="1">
            </div>
            <div class="control-group">
                <label for="hoursPerDay">Hours/Day</label>
                <input type="number" id="hoursPerDay" value="10" min="1">
            </div>
            <div class="control-group">
                <label for="targetUtilization">Target Tech Utilization (%)</label>
                <input type="number" id="targetUtilization" value="85" min="1" max="100">
            </div>
        </div>
        
        <div class="metric-cards">
            <div class="metric-card">
                <h3>Required Technicians</h3>
                <p class="value" id="techsRequired">0</p>
                <p class="detail"></p> 
            </div>
            <div class="metric-card">
                <h3>Annual Services</h3>
                <p class="value" id="annualServices">0</p>
                <p class="detail"></p> 
            </div>
            <div class="metric-card">
                <h3>Total Annual Labor Hours</h3>
                <p class="value" id="totalHours">0</p>
                <p class="detail"></p> 
            </div>
            <div class="metric-card">
                <h3>Total Annual O&M Cost</h3>
                <p class="total-cost-value" id="totalCost">$0M</p>
                <p class="detail"></p> 
            </div>
        </div>
        
        <div class="card">
            <h2>Service Plan Customization & Labor</h2>
            <div class="service-list">
                
                <div class="service-card" id="card-initial">
                    <h4>Initial 50 Hour Service</h4>
                    <div class="service-control">
                        <label for="enable-initial">Enable</label>
                        <input type="checkbox" id="enable-initial" checked onchange="toggleService('initial')">
                    </div>
                    <div class="service-control">
                        <label for="hours-initial">Labor (hrs)</label>
                        <input type="number" id="hours-initial" value="9.9" step="0.1" min="0">
                    </div>
                    <div class="service-control">
                        <label for="parts-initial">Parts Cost/Service ($)</label>
                        <input type="number" id="parts-initial" value="318" step="1" min="0">
                    </div>
                    <div class="stats">
                        <div class="stat-item">Services/Yr: <strong id="stat-initial">0</strong></div>
                        <div class="stat-item">Labor/Yr (Hrs): <strong id="stat-initial-hours">0</strong></div>
                        <div class="stat-item">Parts/Yr ($): <strong id="stat-initial-parts">0</strong></div>
                    </div>
                </div>

                <div class="service-card" id="card-daily">
                    <h4>Daily Checks (24 Hours)</h4>
                    <div class="service-control">
                        <label>Automated</label>
                        <span style="color: green; font-weight: bold;">YES</span>
                    </div>
                    <div class="service-control">
                        <label for="hours-daily">Labor (hrs)</label>
                        <input type="number" id="hours-daily" value="0" step="0.1" disabled>
                    </div>
                    <div class="stats">
                        <div class="stat-item">Services/Yr: <strong id="stat-daily">0</strong></div>
                        <div class="stat-item">Labor/Yr (Hrs): <strong id="stat-daily-hours">0</strong></div>
                        <div class="stat-item">Parts/Yr ($): <strong id="stat-daily-parts">0</strong></div>
                    </div>
                </div>
                
                <div class="service-card" id="card-250">
                    <h4>250 Hour Service</h4>
                    <div class="service-control">
                        <label for="enable-250">Enable</label>
                        <input type="checkbox" id="enable-250" onchange="toggleService('250')"> 
                    </div>
                    <div class="service-control">
                        <label for="interval-250">Interval (Hrs)</label>
                        <input type="number" id="interval-250" value="325" step="1" min="1">
                    </div>
                    <div class="service-control">
                        <label for="hours-250">Labor (hrs)</label>
                        <input type="number" id="hours-250" value="0.55" step="0.05" min="0">
                    </div>
                    <div class="service-control">
                        <label for="parts-250">Parts Cost/Service ($)</label>
                        <input type="number" id="parts-250" value="0" step="1" min="0">
                    </div>
                    <div class="stats">
                        <div class="stat-item">Services/Yr: <strong id="stat-250">0</strong></div>
                        <div class="stat-item">Labor/Yr (Hrs): <strong id="stat-250-hours">0</strong></div>
                        <div class="stat-item">Parts/Yr ($): <strong id="stat-250-parts">0</strong></div>
                    </div>
                </div>
                
                <div class="service-card" id="card-750">
                    <h4>750 Hour Service</h4>
                    <div class="service-control">
                        <label for="enable-750">Enable</label>
                        <input type="checkbox" id="enable-750" checked onchange="toggleService('750')">
                    </div>
                    <div class="service-control">
                        <label for="interval-750">Interval (Hrs)</label>
                        <input type="number" id="interval-750" value="975" step="10" min="1">
                    </div>
                    <div class="service-control">
                        <label for="hours-750">Labor (hrs)</label>
                        <input type="number" id="hours-750" value="8.05" step="0.05" min="0">
                    </div>
                    <div class="service-control">
                        <label for="parts-750">Parts Cost/Service ($)</label>
                        <input type="number" id="parts-750" value="1328" step="1" min="0">
                    </div>
                    <div class="stats">
                        <div class="stat-item">Services/Yr: <strong id="stat-750">0</strong></div>
                        <div class="stat-item">Labor/Yr (Hrs): <strong id="stat-750-hours">0</strong></div>
                        <div class="stat-item">Parts/Yr ($): <strong id="stat-750-parts">0</strong></div>
                    </div>
                </div>

                <div class="service-card" id="card-6500">
                    <h4>6500 Hour Service</h4>
                    <div class="service-control">
                        <label for="enable-6500">Enable</label>
                        <input type="checkbox" id="enable-6500" checked onchange="toggleService('6500')">
                    </div>
                    <div class="service-control">
                        <label for="interval-6500">Interval (Hrs)</label>
                        <input type="number" id="interval-6500" value="8450" step="100" min="100">
                    </div>
                    <div class="service-control">
                        <label for="hours-6500">Labor (hrs)</label>
                        <input type="number" id="hours-6500" value="22.5" step="0.5" min="0">
                    </div>
                    <div class="service-control">
                        <label for="parts-6500">Parts Cost/Service ($)</label>
                        <input type="number" id="parts-6500" value="13251" step="1" min="0">
                    </div>
                    <div class="stats">
                        <div class="stat-item">Services/Yr: <strong id="stat-6500">0</strong></div>
                        <div class="stat-item">Labor/Yr (Hrs): <strong id="stat-6500-hours">0</strong></div>
                        <div class="stat-item">Parts/Yr ($): <strong id="stat-6500-parts">0</strong></div>
                    </div>
                </div>

                <div class="service-card" id="card-8760">
                    <h4>Annual 8760 Hour Service</h4>
                    <div class="service-control">
                        <label for="enable-8760">Enable</label>
                        <input type="checkbox" id="enable-8760" checked onchange="toggleService('8760')">
                    </div>
                    <div class="service-control">
                        <label for="interval-8760">Interval (Hrs)</label>
                        <input type="number" id="interval-8760" value="8760" step="1" min="1" disabled>
                    </div>
                    <div class="service-control">
                        <label for="hours-8760">Labor (hrs)</label>
                        <input type="number" id="hours-8760" value="10.0" step="0.1" min="0">
                    </div>
                    <div class="catalyst-control">
                        <label for="catalyst-8760">Catalyst Not Required</label>
                        <input type="checkbox" id="catalyst-8760" onchange="toggleCatalyst()">
                    </div>
                    <div class="service-control">
                        <label for="parts-8760">Parts Cost/Service ($)</label>
                        <input type="number" id="parts-8760" value="21908" step="1" min="0">
                    </div>
                    <div class="stats">
                        <div class="stat-item">Services/Yr: <strong id="stat-8760">0</strong></div>
                        <div class="stat-item">Labor/Yr (Hrs): <strong id="stat-8760-hours">0</strong></div>
                        <div class="stat-item">Parts/Yr ($): <strong id="stat-8760-parts">0</strong></div>
                    </div>
                </div>

                <div class="service-card" id="card-20000">
                    <h4>20,000 Hour Top End</h4>
                    <div class="service-control">
                        <label for="enable-20000">Enable</label>
                        <input type="checkbox" id="enable-20000" onchange="toggleService('20000')">
                    </div>
                    <div class="service-control">
                        <label for="interval-20000">Interval (Hrs)</label>
                        <input type="number" id="interval-20000" value="26000" step="1000" min="1000">
                    </div>
                    <div class="service-control">
                        <label for="hours-20000">Labor (hrs)</label>
                        <input type="number" id="hours-20000" value="67.45" step="0.05" min="0">
                    </div>
                    <div class="service-control">
                        <label for="parts-20000">Parts Cost/Service ($)</label>
                        <input type="number" id="parts-20000" value="51359" step="1" min="0">
                    </div>
                    <div class="stats">
                        <div class="stat-item">Services/Yr: <strong id="stat-20000">0</strong></div>
                        <div class="stat-item">Labor/Yr (Hrs): <strong id="stat-20000-hours">0</strong></div>
                        <div class="stat-item">Parts/Yr ($): <strong id="stat-20000-parts">0</strong></div>
                    </div>
                </div>
                
                <div class="service-card" id="card-40000">
                    <h4>40,000 Hour Overhaul</h4>
                    <div class="service-control">
                        <label for="enable-40000">Enable</label>
                        <input type="checkbox" id="enable-40000" onchange="toggleService('40000')">
                    </div>
                    <div class="service-control">
                        <label for="interval-40000">Interval (Hrs)</label>
                        <input type="number" id="interval-40000" value="52000" step="1000" min="1000">
                    </div>
                    <div class="service-control">
                        <label for="hours-40000">Labor (hrs)</label>
                        <input type="number" id="hours-40000" value="131" step="1" min="0">
                    </div>
                    <div class="service-control">
                        <label for="parts-40000">Parts Cost/Service ($)</label>
                        <input type="number" id="parts-40000" value="116746" step="1" min="0">
                    </div>
                    <div class="stats">
                        <div class="stat-item">Services/Yr: <strong id="stat-40000">0</strong></div>
                        <div class="stat-item">Labor/Yr (Hrs): <strong id="stat-40000-hours">0</strong></div>
                        <div class="stat-item">Parts/Yr ($): <strong id="stat-40000-parts">0</strong></div>
                    </div>
                </div>

            </div>
        </div>

        <div class="content-layout">
            <div class="card">
                <h2>Annual Service Summary Table</h2>
                <div class="table-card">
                    <table>
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Status</th>
                                <th>Interval (Hrs)</th>
                                <th>Services/Year</th>
                                <th>Labor/Service (Hrs)</th>
                                <th>Total Labor (Hrs/Yr)</th>
                                <th>Parts Cost/Service ($)</th> 
                                <th>Total Parts Cost ($/Yr)</th> 
                                <th>% of Total Labor</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTableBody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div>
                <div class="card">
                    <h3>Service Distribution</h3>
                    <div class="chart-container">
                        <canvas id="serviceChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3>Annual Labor Hour Distribution</h3>
                    <div class="chart-container">
                        <canvas id="laborChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Staffing Ramp-up Projection</h2>
            <div class="chart-container" style="height: 350px;">
                <canvas id="staffingChart"></canvas>
            </div>
        </div>

    </div>

    <script>
        let serviceChart, laborChart, staffingChart;
        
        // --- CONFIGURATION ---
        const LABOR_RATE_PER_HOUR = 65; // Example: $65/hr
        const GENERAL_OVERHEAD_PERCENT = 0.15; // 15% Overhead on (Labor + Parts)
        
        // Cost constants for the 8760 service
        const BASE_8760_PARTS_COST = 21908;
        const CATALYST_COST = 17953; // Using 17953 for a clean $3755 result ($21908 - $3755)
        const NO_CATALYST_PARTS_COST = BASE_8760_PARTS_COST - CATALYST_COST; // $21908 - $17953 = $3755
        
        // Baseline data based on OEM intervals and labor hours for comparison
        let baselineData = {
            techs: 99, 
            services: 37579,
            hours: 191822, 
            cost: 23141000 
        };
        
        // Service definitions
        const serviceDefinitions = [
            {id: 'initial', name: 'Initial 50hr', oneTime: true, defaultInterval: 50},
            {id: 'daily', name: 'Daily Checks', automated: true, defaultInterval: 24},
            {id: '250', name: '250 Hour', defaultInterval: 325},
            {id: '750', name: '750 Hour', defaultInterval: 975},
            {id: '6500', name: '6500 Hour', defaultInterval: 8450},
            {id: '8760', name: 'Annual', defaultInterval: 8760},
            {id: '20000', name: 'Top End', defaultInterval: 26000},
            {id: '40000', name: 'Overhaul', defaultInterval: 52000}
        ];
        // --- END CONFIGURATION ---
        
        // Toggles the 8760 parts cost based on the catalyst checkbox
        function toggleCatalyst() {
            const partsInput = document.getElementById('parts-8760');
            const catalystCheckbox = document.getElementById('catalyst-8760');
            
            if (catalystCheckbox.checked) {
                partsInput.value = NO_CATALYST_PARTS_COST;
            } else {
                partsInput.value = BASE_8760_PARTS_COST;
            }
            // Recalculate the plan immediately after changing the parts cost
            calculatePlan();
        }

        // Toggle service interval and trigger recalculation
        function toggleService(serviceId) {
            const checkbox = document.getElementById(`enable-${serviceId}`);
            const card = document.getElementById(`card-${serviceId}`);
            const intervalInput = document.getElementById(`interval-${serviceId}`);
            const hoursInput = document.getElementById(`hours-${serviceId}`);
            const partsInput = document.getElementById(`parts-${serviceId}`); 
            const catalystCheckbox = document.getElementById(`catalyst-${serviceId}`);
            
            if (checkbox) {
                const isEnabled = checkbox.checked;
                card.classList.toggle('disabled', !isEnabled);
                
                if (intervalInput) intervalInput.disabled = !isEnabled || serviceId === '8760';
                if (hoursInput) hoursInput.disabled = !isEnabled || serviceId === 'daily';
                if (partsInput) partsInput.disabled = !isEnabled || serviceId === 'daily'; 
                if (catalystCheckbox) catalystCheckbox.disabled = !isEnabled;
            }
            
            calculatePlan();
        }
        
        // Load preset values for all inputs
        function loadPreset(scenario) {
            const presets = {
                'oem': {
                    'enable-initial': true, 'hours-initial': 9.9, 'parts-initial': 318,
                    'enable-250': false, 'interval-250': 325, 'hours-250': 0.55, 'parts-250': 0,
                    'enable-750': true, 'interval-750': 975, 'hours-750': 8.05, 'parts-750': 1328,
                    'enable-6500': true, 'interval-6500': 8450, 'hours-6500': 22.5, 'parts-6500': 13251,
                    'enable-8760': true, 'hours-8760': 10.0, 'parts-8760': BASE_8760_PARTS_COST, 'catalyst-8760': false,
                    'enable-20000': false, 'interval-20000': 26000, 'hours-20000': 67.45, 'parts-20000': 51359,
                    'enable-40000': false, 'interval-40000': 52000, 'hours-40000': 131, 'parts-40000': 116746,
                    'totalUnits': 750, 'unitsPerMonth': 50, 'annualRuntime': 6500, 'workingDays': 300, 'hoursPerDay': 10, 'targetUtilization': 85
                },
                'optimized': {
                    'enable-initial': true, 'hours-initial': 5.0, 'parts-initial': 318,
                    'enable-250': true, 'interval-250': 500, 'hours-250': 0.55, 'parts-250': 0,
                    'enable-750': true, 'interval-750': 1500, 'hours-750': 5.5, 'parts-750': 1328,
                    'enable-6500': true, 'interval-6500': 10000, 'hours-6500': 18.0, 'parts-6500': 13251,
                    'enable-8760': true, 'hours-8760': 5.0, 'parts-8760': NO_CATALYST_PARTS_COST, 'catalyst-8760': true,
                    'enable-20000': true, 'interval-20000': 30000, 'hours-20000': 60.0, 'parts-20000': 51359,
                    'enable-40000': true, 'interval-40000': 60000, 'hours-40000': 120.0, 'parts-40000': 116746,
                    'totalUnits': 750, 'unitsPerMonth': 50, 'annualRuntime': 6500, 'workingDays': 300, 'hoursPerDay': 10, 'targetUtilization': 90
                }
            };
            
            const data = presets[scenario];
            for (const id in data) {
                const element = document.getElementById(id);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = data[id];
                        // Manually call specialized toggles
                        if (id.startsWith('enable-')) {
                            toggleService(id.replace('enable-', ''));
                        } else if (id === 'catalyst-8760') {
                            toggleCatalyst(); // This function already calls calculatePlan()
                        }
                    } else {
                        element.value = data[id];
                    }
                }
            }
            // Ensure calculatePlan is called after setting all primary inputs, in case a toggle didn't run it.
            calculatePlan(); 
        }

        // Initialize charts
        function initCharts() {
            // Service distribution chart
            serviceChart = new Chart(document.getElementById('serviceChart'), {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Labor hours chart
            laborChart = new Chart(document.getElementById('laborChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Labor Hours',
                        data: [],
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Staffing chart
            staffingChart = new Chart(document.getElementById('staffingChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Technicians Required',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.3,
                        pointRadius: 4,
                        fill: 'start'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: 10, // A sensible starting max
                            title: {
                                display: true,
                                text: 'Required Technicians (Rounded Up)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Calculate the service plan - THE CORE FUNCTION
        function calculatePlan() {
            const totalUnits = parseInt(document.getElementById('totalUnits').value) || 0;
            const unitsPerMonth = parseInt(document.getElementById('unitsPerMonth').value) || 0;
            const annualRuntime = parseInt(document.getElementById('annualRuntime').value) || 0;
            const workingDays = parseInt(document.getElementById('workingDays').value) || 0;
            const hoursPerDay = parseInt(document.getElementById('hoursPerDay').value) || 0;
            const utilization = (parseInt(document.getElementById('targetUtilization').value) || 0) / 100;
            
            let totalServices = 0;
            let totalLaborHours = 0;
            let totalPartsCost = 0; 
            const serviceData = [];
            const laborData = [];
            let tableHTML = '';

            // 1. Calculate all metrics
            serviceDefinitions.forEach(service => {
                const enableCheckbox = document.getElementById(`enable-${service.id}`);
                const isEnabled = service.automated || service.oneTime || (enableCheckbox && enableCheckbox.checked);

                if (!isEnabled && !service.oneTime) {
                    // Update stats to 0 for disabled services
                    document.getElementById(`stat-${service.id}`).textContent = 0;
                    document.getElementById(`stat-${service.id}-hours`).textContent = 0;
                    document.getElementById(`stat-${service.id}-parts`).textContent = 0;
                    
                    // Add disabled row to table
                    tableHTML += `<tr class="disabled"><td>${service.name}</td><td>Disabled</td><td>-</td><td>0</td><td>-</td><td>0</td><td>-</td><td>$0</td><td>0%</td></tr>`;
                    return; // Skip calculations for disabled services (except initial)
                }

                // Get dynamic values
                const intervalInput = document.getElementById(`interval-${service.id}`);
                const hoursInput = document.getElementById(`hours-${service.id}`);
                const partsInput = document.getElementById(`parts-${service.id}`);

                const interval = (intervalInput && !intervalInput.disabled) ? parseInt(intervalInput.value) : (service.defaultInterval || 0);
                const laborHoursPerService = (hoursInput && !hoursInput.disabled) ? parseFloat(hoursInput.value) : 0;
                const partsCostPerService = (partsInput && !partsInput.disabled) ? parseFloat(partsInput.value) : 0;
                
                let annualServices;

                if (service.oneTime) {
                    // Initial service is only done once per unit, regardless of runtime
                    annualServices = totalUnits; 
                } else if (service.automated) {
                    // Daily checks are always considered 365 per unit
                    annualServices = totalUnits * (365 / (interval/24)); 
                } else if (interval > 0) {
                    // Standard interval service
                    annualServices = Math.floor(annualRuntime / interval) * totalUnits;
                } else {
                    annualServices = 0;
                }
                
                const totalLabor = annualServices * laborHoursPerService;
                const totalParts = annualServices * partsCostPerService;

                // Accumulate totals
                totalServices += annualServices;
                totalLaborHours += totalLabor;
                totalPartsCost += totalParts;

                // Update service card stats
                document.getElementById(`stat-${service.id}`).textContent = annualServices.toLocaleString();
                document.getElementById(`stat-${service.id}-hours`).textContent = Math.round(totalLabor).toLocaleString();
                document.getElementById(`stat-${service.id}-parts`).textContent = `$${Math.round(totalParts).toLocaleString()}`;
                
                // Add data for charts
                if (annualServices > 0) {
                    serviceData.push({name: service.name, value: annualServices});
                    if (totalLabor > 0) {
                        laborData.push({name: service.name, value: totalLabor});
                    }
                }
            });

            // 2. Finalize Metrics
            const totalAvailableHours = workingDays * hoursPerDay * utilization;
            const techsRequired = Math.ceil(totalLaborHours / totalAvailableHours) || 0;
            const totalOMCost = (totalLaborHours * LABOR_RATE_PER_HOUR) + totalPartsCost;
            const finalCost = totalOMCost * (1 + GENERAL_OVERHEAD_PERCENT);

            // Calculate total Labor Per Unit for Staffing Ramp-up
            const totalLaborPerUnit = (totalLaborHours / totalUnits) || 0;
            
            // 3. Update Summary Table with percentages and totals
            serviceDefinitions.forEach(service => {
                const isEnabled = document.getElementById(`enable-${service.id}`) ? document.getElementById(`enable-${service.id}`).checked : !service.automated;
                if (!isEnabled && !service.oneTime) return;

                const intervalInput = document.getElementById(`interval-${service.id}`);
                const hoursInput = document.getElementById(`hours-${service.id}`);
                const partsInput = document.getElementById(`parts-${service.id}`);
                
                const interval = (intervalInput && !intervalInput.disabled) ? parseInt(intervalInput.value) : (service.defaultInterval || 0);
                const laborHoursPerService = (hoursInput && !hoursInput.disabled) ? parseFloat(hoursInput.value) : 0;
                const partsCostPerService = (partsInput && !partsInput.disabled) ? parseFloat(partsInput.value) : 0;
                const annualServices = parseFloat(document.getElementById(`stat-${service.id}`).textContent.replace(/,/g, ''));
                const totalLabor = annualServices * laborHoursPerService;
                const totalParts = annualServices * partsCostPerService;
                
                const laborPercent = totalLaborHours > 0 ? (totalLabor / totalLaborHours) * 100 : 0;

                tableHTML += `
                    <tr>
                        <td>${service.name}</td>
                        <td>${isEnabled ? 'Enabled' : (service.automated ? 'Auto' : 'Disabled')}</td>
                        <td>${interval > 0 ? interval.toLocaleString() : '-'}</td>
                        <td>${annualServices.toLocaleString()}</td>
                        <td>${laborHoursPerService.toFixed(2)}</td>
                        <td>${Math.round(totalLabor).toLocaleString()}</td>
                        <td>$${Math.round(partsCostPerService).toLocaleString()}</td>
                        <td>$${Math.round(totalParts).toLocaleString()}</td>
                        <td>${laborPercent.toFixed(1)}%</td>
                    </tr>
                `;
            });
            
            // Add total row
            tableHTML += `
                <tr class="total-row">
                    <td>TOTALS</td>
                    <td></td>
                    <td></td>
                    <td>${totalServices.toLocaleString()}</td>
                    <td></td>
                    <td>${Math.round(totalLaborHours).toLocaleString()}</td>
                    <td></td>
                    <td>$${Math.round(totalPartsCost).toLocaleString()}</td>
                    <td>100.0%</td>
                </tr>
            `;

            document.getElementById('summaryTableBody').innerHTML = tableHTML;
            
            // 4. Update Metric Cards
            document.getElementById('techsRequired').textContent = techsRequired.toLocaleString();
            document.getElementById('annualServices').textContent = totalServices.toLocaleString();
            document.getElementById('totalHours').textContent = Math.round(totalLaborHours).toLocaleString();
            document.getElementById('totalCost').textContent = `$${(finalCost / 1000000).toFixed(2)}M`;

            // 5. Update Charts
            
            // Service Chart (Doughnut)
            serviceChart.data.labels = serviceData.map(d => d.name);
            serviceChart.data.datasets[0].data = serviceData.map(d => d.value);
            serviceChart.update();
            
            // Labor Chart (Bar)
            laborChart.data.labels = laborData.map(d => d.name);
            laborChart.data.datasets[0].data = laborData.map(d => Math.round(d.value));
            laborChart.update();
            
            // Staffing Chart (Line)
            const maxMonths = 24; // Max months to show on the ramp-up
            const monthsToFullFleet = unitsPerMonth > 0 ? Math.ceil(totalUnits / unitsPerMonth) : 0;
            const monthsToShow = Math.min(maxMonths, monthsToFullFleet + 6); // Show up to maxMonths or 6 months past full fleet
            
            const monthLabels = [];
            const techData = [];
            
            const availableHoursPerTech = workingDays * hoursPerDay * utilization;

            for (let i = 1; i <= monthsToShow; i++) {
                monthLabels.push(`Month ${i}`);
                
                // Calculate units active up to the current month
                const unitsActive = Math.min(totalUnits, unitsPerMonth * i);
                
                // Calculate the proportional labor hours required for the currently active units
                const proportionalLabor = unitsActive * totalLaborPerUnit;
                
                // Calculate required techs based on proportional labor
                const requiredTechs = Math.ceil(proportionalLabor / availableHoursPerTech) || 0;
                
                techData.push(requiredTechs);
            }
            
            staffingChart.data.labels = monthLabels;
            staffingChart.data.datasets[0].data = techData;
            staffingChart.options.scales.y.suggestedMax = Math.max(10, Math.ceil(techsRequired * 1.1));
            staffingChart.update();
        }

        // Event Listeners for Initial Setup
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            
            // Add listeners to all relevant input fields (exclude those handled by specialized functions like toggleService)
            document.querySelectorAll('input[type="number"], input[type="checkbox"]').forEach(input => {
                if (!input.id.startsWith('enable-') && input.id !== 'catalyst-8760') {
                    input.addEventListener('change', calculatePlan);
                }
            });
            
            // Preset buttons event listeners
            document.getElementById('preset-oem').addEventListener('click', function() {
                document.querySelectorAll('.scenario-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                loadPreset('oem');
            });
            
            document.getElementById('preset-optimized').addEventListener('click', function() {
                document.querySelectorAll('.scenario-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                loadPreset('optimized');
            });

            // Initial calculation: load default preset and calculate
            loadPreset('oem'); 
        });
    </script>
</body>
</html>
